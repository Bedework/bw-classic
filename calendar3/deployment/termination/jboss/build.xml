<?xml version="1.0"?>

<!-- ===================================================================
     Termination buildfile for jboss (j2ee) deployment
     =================================================================== -->

<project name="app.deploy" default="deploy" >
  <target name="init">
    <dirname property="this.dir" file="${ant.file}"/>

    <property name="app.ear.file"
              location="${dist.home}/${org.bedework.global.ear.name}.ear" />
    <property name="app.resources.dir"
              location="${this.dir}/../webapp/resources" />
  </target>

  <!-- =================================================================
       The "deploy" target builds a single ear file out of the results.
       ================================================================= -->

  <target name="deploy" depends="init,build.configured" >
    <echo message="***************************************************************" />
    <echo message="Building ear file for jboss deployment" />
    <echo message="***************************************************************" />

    <property name="ear.dir"
              location="${org.bedework.temp.home}/ear" />

    <path id="app.xml.cp">
      <pathelement location="${org.bedework.deployment.jar}"/>
    </path>

    <taskdef name="applicationXml"
             classname="org.bedework.deployment.ApplicationXmlTask">
      <classpath refid="app.xml.cp"/>
    </taskdef>

    <!-- We have to drop some of the libraries so they don't conflict -->
    <copy toDir="${ear.dir}">
      <fileset dir="${org.bedework.temp.home}/earlib">
        <exclude name="commons-logging*" />
        <exclude name="log4j*" />
      </fileset>
    </copy>

    <applicationXml displayName="Bedework calendar suite"
                    outFile="${ear.dir}/META-INF/application.xml"
                    warDir="${org.bedework.temp.home}/wars">
      <fileset dir="${ear.dir}">
        <include name="*.jar"/>
      </fileset>
    </applicationXml>

    <manifest file="${ear.dir}/META-INF/MANIFEST.MF" />

    <copy toDir="${ear.dir}">
      <fileset dir="${org.bedework.temp.home}/wars"/>
    </copy>

    <zip destfile="${app.ear.file}"
         basedir="${ear.dir}"/>
  </target>

  <target name="build.configured" >
    <!-- ===============================================================
         Nothing to do here
         =============================================================== -->
  </target>
</project>
