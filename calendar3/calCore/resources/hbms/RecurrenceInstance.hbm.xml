<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
  "-//Hibernate/Hibernate Mapping DTD//EN"
  "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<!-- ===================================================================
     RecurrenceInstance
     =================================================================== -->

<hibernate-mapping>
  <class name="org.bedework.calfacade.BwRecurrenceInstance"
         table="recurrences">
    <composite-id>
      <key-property name="recurrenceId"
                    column="recurrence_id" type="string" />
      <key-many-to-one name="master" column="masterid"
                       class="org.bedework.calfacade.BwEventObj" />
    </composite-id>
    <component name="dtstart"
               class="org.bedework.calfacade.BwDateTime" >
      <property name="dateType" column="start_date_type" type="true_false"
                not-null="true" />
      <property name="tzid" column="start_tzid" type="string" />
      <property name="dtval" column="start_dtval" type="string"
                not-null="true" />
      <property name="date" column="start_date" type="string"
                not-null="true"
                index="idx_recur_start" />
    </component>

    <!-- All day events and events which end when they start have no
         end date/time -->
    <component name="dtend"
               class="org.bedework.calfacade.BwDateTime" >
      <property name="dateType" column="end_date_type" type="true_false" />
      <property name="tzid" column="end_tzid" type="string" />
      <property name="dtval" column="end_dtval" type="string" />
      <property name="date" column="end_date" type="string"
                index="idx_recur_end" />
    </component>

    <many-to-one name="override"
                 class="org.bedework.calfacade.BwEventAnnotation"
                 column="overrideid"
                 cascade="delete" />
  </class>

  <!-- =================================================================
       RecurrenceInstance queries
       ================================================================= -->

  <query name="getEventRecurrences"><![CDATA[
    from org.bedework.calfacade.BwRecurrenceInstance as r
      where r.master=:event
  ]]></query>

  <query name="getCalendarRecurrences"><![CDATA[
    from org.bedework.calfacade.BwRecurrenceInstance as r
      where r.master.calendar=:calendar
  ]]></query>
</hibernate-mapping>

