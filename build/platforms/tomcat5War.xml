<?xml version="1.0"?>

<!-- ===================================================================
     This file is imported by buildwar.xml and adds the targets
     which will be invoked by the buildwar targets.
        addLibs: add libraries for this platform
        doPlatform - misc stuff
        deployWar: deploy the war to the server
        deployEar: deploy the ear to the server 
     =================================================================== -->

<project name="bedework.platformWar" default="doPlatform" >
  <target name="doPlatform" >
    <property name="propval.app.tomcat.context.xml"
              location="${app.sou.dir}/war/META-INF/context.xml" />
    <resolveFile name="app.tomcat.context.xml"
                 file="${propval.app.tomcat.context.xml}"
                 base="${app.sou.dir}"/>

    <copy tofile="${app.dest.metainf}/context.xml"
          file="${app.tomcat.context.xml}"
          overwrite="yes" >
      <filterset refid="property.filters" />
    </copy>
  </target>
  
  <!-- ================================================================
       Add libraries
       ================================================================ -->

  <target name="addLibs">
    <!-- Library in war file -->
    <property name="app.dest.lib"
              location="${app.dest.webinf}/lib" />

    <!-- hibernate jars -->
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.antlr}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.asm-attrs}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.asm}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.cglib}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.dom4j}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.ehcache}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.hibernate}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.javassist}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jgroups}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jta}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.slf4j-api}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.slf4j-log4j12}" />

    <!-- jms support -->
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.activemq-core}" />
    <copy todir="${app.dest.lib}"
          file="${org.bedework.appjar.geronimo-j2ee-management_1.0_spec}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jms}" />

    <if>
      <isset property="org.bedework.build.caldav.google" />
      <then>
        <copy todir="${app.dest.lib}">
          <fileset dir="${google.dir}">
            <include name="*.jar"/>
          </fileset>
        </copy>
      </then>
    </if>

    <!-- ===============================================================
         Any jar files required
         =============================================================== -->

    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-annotations}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.rpiaccess}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.rpiutil}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-davio}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-apiutil}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-calcore}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-calcorei}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-calfacade}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-calsvc}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-calsvci}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-client}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-icalendar}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-logging}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-mail}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-sysevents}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.bw-appcommon}" />

    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.lucene-core}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.lucene-misc}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.ical4j}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-codec}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-collections}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-httpclient}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-lang}"/>
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-ssl}"/>

    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.log4j}"/>

    <!-- Mail related stuff -->
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.activation}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.dsn}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.imap}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.mailapi}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.pop3}" />
    <copy todir="${app.dest.lib}" file="${org.bedework.appjar.smtp}" />

    <!-- any extra files-->
    <copy todir="${app.dest.lib}" >
      <fileset dir="${org.bedework.temp.extrajars.dir}" />
    </copy>
    
    <if>
      <isset property="org.bedework.strutsapp" />
      <then>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.serializer}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.xalan}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.struts}"/>

        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-beanutils}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-digester}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-fileupload}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-logging}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.commons-validator}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jakarta-oro}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jstl}"/>
        <copy todir="${app.dest.lib}" file="${org.bedework.appjar.jstl-standard}"/>
      </then>
    </if>
  </target>
  
  <!-- ================================================================
       Deploy war
       ================================================================ -->

  <target name="deployWar">
    <echo message="***************************************************************" />
    <echo message="Deploying standalone app ${app.war.file} into ${org.bedework.appserver.dir}/${propval.app.deploy.dir}" />
    <echo message="***************************************************************" />

    <!-- copy the war file. -->
    <copy todir="${org.bedework.appserver.dir}/${propval.app.deploy.dir}" file="${app.war.file}"
          overwrite="yes" />

    <!-- Delete expanded version -->
    <delete dir="${org.bedework.appserver.dir}/${propval.app.deploy.dir}/${propval.app.war.name}" />

    <!-- Delete the quickstart context def -->
    <delete file="${org.bedework.appserver.dir}/conf/Catalina/localhost/${propval.app.war.name}.xml" />
  </target>
    
  <!-- ================================================================
       Deploy ear
       ================================================================ -->

  <target name="deployEar">
  	<!-- Noop for tomcat -->
  </target>
</project>