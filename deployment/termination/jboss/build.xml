<?xml version="1.0"?>

<!-- ===================================================================
     Termination buildfile for jboss (j2ee) deployment
     =================================================================== -->

<project name="app.deploy" default="deploy" >
  <target name="init">
    <dirname property="this.dir" file="${ant.file}"/>

    <property name="app.ear.file"
              location="${dist.home}/${org.bedework.global.ear.name}.ear" />
    <property name="app.resources.dir"
              location="${this.dir}/../webapp/resources" />
  </target>

  <!-- =================================================================
       The "deploy" target builds a single ear file out of the results.
       ================================================================= -->

  <target name="deploy" depends="init,build.configured" >
    <echo message="***************************************************************" />
    <echo message="Building ear file for jboss deployment" />
    <echo message="***************************************************************" />

    <property name="ear.dir"
              location="${org.bedework.temp.dir}/ear" />

    <property name="properties.dir"
              location="${org.bedework.temp.dir}/ear-properties" />

    <property name="ear-properties.jar"
              location="${ear.dir}/bw-ear-properties.jar"/>

    <path id="app.xml.cp">
      <pathelement location="${org.bedework.deployutil.jar}"/>
    </path>

    <taskdef name="applicationXml"
             classname="org.bedework.deployment.ApplicationXmlTask">
      <classpath refid="app.xml.cp"/>
    </taskdef>

    <!-- We have to drop some of the libraries so they don't conflict -->
    <copy toDir="${ear.dir}">
      <fileset dir="${org.bedework.temp.dir}/earlib">
        <exclude name="commons-logging*" />
        <exclude name="log4j*" />
        <exclude name="jgroup*" />
        <exclude name="servlet.jsp*" />
      </fileset>
    </copy>

    <copy toDir="${properties.dir}" flatten="yes" overwrite="yes" >
      <fileset dir="${org.bedework.temp.wars.home}">
        <include name="**/classes/*xml"/>
        <include name="**/classes/*properties"/>
      </fileset>
    </copy>

    <copy toDir="${properties.dir}/properties/calendar" flatten="yes" overwrite="yes" >
      <fileset dir="${org.bedework.temp.wars.home}">
        <include name="**/classes/properties/calendar/*"/>
      </fileset>
    </copy>

    <jar jarfile="${ear-properties.jar}">
      <fileset dir="${properties.dir}"/>
    </jar>

    <applicationXml displayName="Bedework calendar suite"
                    outFile="${ear.dir}/META-INF/application.xml"
                    warDir="${org.bedework.temp.dir}/wars"
                    contexts="${org.bedework.global.context.roots}">
      <fileset dir="${ear.dir}">
        <include name="*.jar"/>
      </fileset>
    </applicationXml>

    <manifest file="${ear.dir}/META-INF/MANIFEST.MF" />

    <copy toDir="${ear.dir}">
      <fileset dir="${org.bedework.temp.wars.home}">
        <exclude name="**/WEB-INF/classes/**/*"/>
      </fileset>
    </copy>

    <zip destfile="${app.ear.file}"
         basedir="${ear.dir}"/>
  </target>

  <target name="build.configured" >
    <!-- ===============================================================
         Nothing to do here
         =============================================================== -->
  </target>
</project>
