<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
  "-//Hibernate/Hibernate Mapping DTD//EN"
  "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<!-- ===================================================================
     An Event Annotation in Bedework.
     This refers to another event (possibly also an annotation) and holds
     changes to that event.

     This definition differs from The event definition only in that all
     fields (except the index and sequence) may be null and the event does
     not have a reference to another event.
     =================================================================== -->

<hibernate-mapping>
  <class name="org.bedework.calfacade.BwEventAnnotation"
         table="eventAnnotations">
    <id name="id" type="integer" column="eventid" unsaved-value="-1">
      <generator class="native"/>
    </id>

    <version name="seq" column="seq" type="integer" />

    <many-to-one name="creator"
                 class="org.bedework.calfacade.BwUser" >
      <column name="creatorid" index="idx_eventann_creator" />
    </many-to-one>

    <many-to-one name="owner"
                 class="org.bedework.calfacade.BwUser"
                 unique="true">
      <column name="ownerid"
              index="sidx_eventann_owner" />
    </many-to-one>

    <property name="access" column="access" type="text" />

    <property name="publick" type="true_false" >
      <column name="publick" />
    </property>

    <component name="dtstart"
               class="org.bedework.calfacade.BwDateTime" >
      <property name="dateType" column="start_date_type" type="true_false"
                />
      <property name="tzid" column="start_tzid" type="string" />
      <property name="dtval" column="start_dtval" type="string"
                />
      <property name="date" column="start_date" type="string"
                index="idx_eventann_start" />
    </component>

    <!-- All day events and events which end when they start have no
         end date/time -->
    <component name="dtend"
               class="org.bedework.calfacade.BwDateTime" >
      <property name="dateType" column="end_date_type" type="true_false" />
      <property name="tzid" column="end_tzid" type="string" />
      <property name="dtval" column="end_dtval" type="string" />
      <property name="date" column="end_date" type="string"
                index="idx_eventann_end" />
    </component>

    <property name="duration" column="duration" type="string" />

    <property name="endType" column="end_type" type="char"
              />

    <property name="deleted" type="true_false">
      <column name="deleted"
              index="idx_eventann_deleted" />
    </property>

    <property name="summary" type="string" >
      <column name="summary" />
    </property>
    <property name="description" column="description" type="text"/>

    <property name="link" column="link" type="string" />

    <property name="status" type="string" />

    <property name="cost" column="cost" type="string"/>

    <many-to-one name="organizer"
                 class="org.bedework.calfacade.BwOrganizer"
                 column="organizerid"
                 unique="true"/>

    <many-to-one name="calendar"
                 class="org.bedework.calfacade.BwCalendar"
                 column="calendarid"
                 index="idx_eventann_calendar" unique-key="eventann-key" />

    <property name="dtstamp" column="dtstamp" type="string" />

    <property name="lastmod" type="string" >
      <column name="lastmod" />
    </property>

    <property name="created" type="string">
      <column name="created" />
    </property>

    <property name="priority" type="integer" >
      <column name="priority" />
    </property>

    <many-to-one name="sponsor"
                 class="org.bedework.calfacade.BwSponsor" >
      <column name="sponsorid" index="idx_eventann_sponsor" />
    </many-to-one>

    <many-to-one name="location"
                 class="org.bedework.calfacade.BwLocation" >
      <column name="locationid" index="idx_eventann_location" />
    </many-to-one>

    <property name="name" column="eventname" type="text"/>

    <!-- calendar + guid + recurrence-id is a unique key. -->
    <property name="guid" type="string" length="500" unique-key="eventann-key" />

    <property name="sequence" type="integer" />

    <property name="transparency" column="transparency" type="text"/>

    <property name="categoriesChanged" type="true_false">
      <column name="categories_changed" />
    </property>

    <set name="categories" table="event_annotation_categories"
         lazy="true" >
      <key column="eventid"/>
      <many-to-many class="org.bedework.calfacade.BwCategory"
                    column="categoryid"/>
    </set>

    <property name="attendeesChanged" type="true_false">
      <column name="attendees_changed" />
    </property>

    <set name="attendees" table="event_annotation_attendees"
         cascade="all-delete-orphan" >
      <key column="attendeeid"/>
      <many-to-many class="org.bedework.calfacade.BwAttendee" />
    </set>

    <!-- We don't map the alarms because generally we have to fetch them
         based on critera we cannot derive from the event.

         Generally we only fetch the alarms for a given event and the
         curremt user.
    <set name="alarms" table="event_alarms"
         lazy="true"
         cascade="all-delete-orphan" >
      <key column="eventid" />
      <many-to-many class="org.bedework.calfacade.BwEventAlarm"
                    column="id"/>
    </set>
         -->

    <property name="recurring" type="true_false" column="recurring"
              index="idx_eventann_recurring" />

    <property name="recurrenceChanged" type="true_false">
      <column name="recurrence_changed" />
    </property>

    <component name="recurrence"
               class="org.bedework.calfacade.BwRecurrence" >
      <set name="rrules" lazy="true" table="event_annotationrrules"
           cascade="all,delete-orphan">
        <key column="eventid"/>
        <element type="string" column="rrule"/>
      </set>

      <set name="rdates" lazy="true" table="event_annotationrdates"
           cascade="all,delete-orphan">
        <key column="eventid"/>
        <element type="string" column="rdate" />
      </set>

      <set name="exdates" lazy="true" table="event_annotationexdates"
           cascade="all,delete-orphan">
        <key column="eventid"/>
        <element type="string" column="exdate" />
      </set>

      <property name="recurrenceId" column="recurrence_id" type="string"
                unique-key="eventann-key" />

      <property name="latestDate" column="latest_date" type="string"
                index="idx_eventann_latest_date" />

      <property name="expanded" type="true_false" column="expanded"
                index="idx_eventann_expanded" />
    </component>

    <many-to-one name="target"
                 class="org.bedework.calfacade.BwEventObj" lazy="proxy" >
      <column name="targetid" />
    </many-to-one>

    <many-to-one name="master"
                 class="org.bedework.calfacade.BwEventObj" lazy="proxy" >
      <column name="masterid" />
    </many-to-one>
  </class>

  <!-- =================================================================
       Event queries
       ================================================================= -->

       <!--
  <query name="eventsByName"><![CDATA[
    from org.bedework.calfacade.BwEvent as ev
      where ev.name = :name and ev.calendar = :cal
  ]]></query>
  -->
</hibernate-mapping>

