<?xml version="1.0"?>

<!-- ===================================================================
     Default personal events web application deployer
     =================================================================== -->

<project name="bwpersonal.deploy" default="deploy" >
  <import file="${org.bedework.deployment.base}/deployprops.xml" />

  <dirname property="this.dir" file="${ant.file}"/>

  <import file="${this.dir}/appjars.xml" />

  <target name="init" >
    <getExtraJars />

    <property name="app.war.file"
              location="${dist.home}/${propval.app.war.name}.war" />

    <property name="app.sou.dir" location="${org.bedework.deploy.app.sou}" />

    <property name="org.bedework.use.dojo" value="true" />

    <!-- Flag as struts -->
    <property name="org.bedework.strutsapp" value="true" />

    <!-- Properties that differ from the public client -->
    <!--
    <property name="app.web.xml"
              value="${app.sou.dir}/war/WEB-INF/web.xml" />
              -->

    <property name="app.resources.dir"
              location="${this.dir}/resources" />
  </target>

  <!-- =================================================================
       The "deploy" target first builds a configured component then copies
       all required files to the appropriate servlet container directories.

       Currently this only works for the quickstart distribution.
       For example, it does not handle deploying into jboss and copying
       resource files (images, stylesheets) to external locations.
       ================================================================= -->

  <target name="deploy" depends="init,build.configured" >
    <!-- First copy the resources into the server -->

    <if>
      <not>
        <isset property="org.bedework.global.noskins" />
      </not>
      <then>
        <delete dir="${org.bedework.appserver.dir}/${propval.app.resources.dir}" />
        <copy todir="${org.bedework.appserver.dir}/${propval.app.resources.dir}">
          <fileset dir="${app.resources.dir}/demoskins" />
        </copy>


        <if>
          <isset property="org.bedework.global.portal.platform" />
          <then>
            <!-- The intent is to have a set of quickstart skins configured for
                 portal use. So far we've not managed that so for the time being we
                 will just use the standalone skin set. -->
            <property name="dest.skins.dir"
                      location="${org.bedework.appserver.dir}/${propval.app.resources.dir}.${org.bedework.global.portal.platform}" />
            <delete dir="${dest.skins.dir}" />
            <copy todir="${dest.skins.dir}">
              <fileset dir="${app.resources.dir}/demoskins" />
            </copy>
          </then>
        </if>
      </then>
    </if>

    <!-- Deploy common resources -->
    <!--
    <ant antfile="${org.bedework.common.resources}/build.xml"
         inheritrefs="true" target="deploy" >
      <property name="app.common.resources.dest.dir"
                location="${org.bedework.appserver.dir}/${propval.app.resources.dir}/resources" />
    </ant>
    -->

    <echo message="***************************************************************" />
    <echo message="Deploying standalone app ${app.war.file} into ${org.bedework.appserver.dir}/${propval.app.deploy.dir}" />
    <echo message="***************************************************************" />

    <!-- copy the war file. -->
    <copy todir="${org.bedework.appserver.dir}/${propval.app.deploy.dir}" file="${app.war.file}"
          overwrite="yes" />

    <!-- Delete expanded version -->
    <delete dir="${org.bedework.appserver.dir}/${propval.app.deploy.dir}/${propval.app.war.name}" />

    <!-- Delete the quickstart context def -->
    <delete file="${org.bedework.appserver.dir}/conf/Catalina/localhost/${propval.app.war.name}.xml" />

    <if>
      <isset property="org.bedework.global.portal.platform" />
      <then>
        <ant antfile="${org.bedework.deploy.type.dir}/${org.bedework.global.portal.platform}/build.xml"
             inheritrefs="true" target="deploy" />
      </then>
    </if>
  </target>

  <target name="build.configured" depends="init" >
    <!-- ===============================================================
         Build the war
         =============================================================== -->

    <ant antfile="${buildwar}" inheritRefs="true" target="build" />
  </target>
</project>

