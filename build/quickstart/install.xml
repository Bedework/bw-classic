<?xml version="1.0"?>

<!-- Install the bedework Calendar quickstart.

     This is imported by the quickstart build.xml ensuring all changes to this file
     appear in the repository.

     Authors: Mike Douglass   douglm - rpi.edu
-->

<project name="quickstart-install" default="install" basedir=".">
  <target name="run.init">
    <property name="org.bedework.project.bedework"
              location="${basedir}/bedework" />

    <property name="org.bedework.directory.dir"
              location="${org.bedework.project.bedework}/../apacheds-1.5.3.fixed" />
  </target>

  <!-- =================================================================
       The "install" target does the install

       1. Copy bwbuild into the users home directory
       2. If a new directory is needed
            a. init the directory
            b. Create a caladmin user with supplied password
            c. Create a test user
          If a directory is to be copied from a previous quickstart, copy the
          directory server files.
       ================================================================= -->

  <target name="install" depends="run.init"
          description="Install the quickstart">
    <echo message="Create bwbuild in user home"/>

    <if>
      <available file="${user.home}/bwbuild" type="dir" />
      <then>
        <echo message="========================================================" />
        <echo message="You already have a bwbuild in user home ${user.home}" />
        <echo message="Enter 'yes' to continue with the directory unchanged" />
        <echo message="(you may need to update it afterwards)" />
        <echo message="Enter anything else to terminate the install allowing " />
        <echo message="you to rename or destroy it." />
        <echo message="========================================================" />

        <input message="Continue? yes/no"
               addproperty="org.bedework.install.bwbuild.reply" />

        <if>
          <not>
            <equals arg1="${org.bedework.install.bwbuild.reply}" arg2="yes" />
          </not>
          <then>
            <fail />
          </then>
        </if>
      </then>
      <else>
        <copy toDir="${user.home}/bwbuild" >
          <fileset dir="${org.bedework.project.bedework}/config/bwbuild" />
        </copy>
      </else>
    </if>

    <echo message="========================================================" />
    <echo message="We need to create a new directory for the quickstart" />
    <!-- This after 3.5
    <echo message="or copy a previous quickstart directory into the new quickstart" />
    -->
    <echo message="========================================================" />

    <echo message="Creating a new directory for the quickstart" />
    <parallel>
      <daemons>
        <antcall target="dirstart" inheritrefs="true" />
      </daemons>
      <sequential>
        <sleep seconds="10" />
        <antcallback target="initDir" inheritrefs="true"
                     return="org.bedework.directory.init.status" />
        <if>
          <equals arg1="${org.bedework.directory.init.status}" arg2="0" />
          <then>
            <echo message="Initialisation went OK" />
            <property name="org.bedework.install.dirinit.reply" value="yes" />
          </then>
          <elseif>
            <equals arg1="${org.bedework.directory.init.status}" arg2="1" />
            <then>
              <echo message="========================================================" />
              <echo message="The directory appears to be initialised already" />
              <echo message="========================================================" />

              <input message="Continue with adding users/groups? yes/no"
                     addproperty="org.bedework.install.dirinit.reply" />
              <echo message="" />
            </then>
          </elseif>
          <else>
            <echo message="Initialisation failed" />

          </else>
        </if>

        <if>
          <equals arg1="${org.bedework.install.dirinit.reply}" arg2="yes" />
          <then>
            <echo message="======== super user info =======" />

            <input message="Account name for superuser"
                   defaultvalue="caladmin"
                   addproperty="org.bedework.install.superuser.account" />

            <input message="Account password for superuser"
                   addproperty="org.bedework.install.superuser.password" />

            <echo message="======== Administrative user info =======" />

            <input message="Account name for an administrative user"
                   defaultvalue="calowner01"
                   addproperty="org.bedework.install.admin.account" />

            <input message="Account password for an administrative user"
                   addproperty="org.bedework.install.admin.password" />

            <echo message="======== personal calendar user info =======" />

            <input message="Account name for a test user"
                   defaultvalue="testuser01"
                   addproperty="org.bedework.install.testuser.account" />

            <input message="Account password for test user"
                   addproperty="org.bedework.install.testuser.password" />

            <echo message="======== Create superuser =======" />

            <addBedeworkUser account="${org.bedework.install.superuser.account}"
                             firstName="first"
                             lastName="last"
                             password="${org.bedework.install.superuser.account}" />

            <echo message="======== Create administrative user =======" />

            <addBedeworkUser account="${org.bedework.install.admin.account}"
                             firstName="first"
                             lastName="last"
                             password="${org.bedework.install.admin.account}" />

            <echo message="======== Create personal calendar user =======" />

            <addBedeworkUser account="${org.bedework.install.testuser.account}"
                             firstName="first"
                             lastName="last"
                             password="${org.bedework.install.testuser.account}" />
          </then>
        </if>

        <antcall target="dirstop" inheritrefs="true" />
      </sequential>
    </parallel>

    <!-- =================================================================
         Some final reminders
         ================================================================= -->

    <if>
      <isset property="org.bedework.install.bwbuild.reply" />
      <then>
        <echo message="========================================================" />
        <echo message="Note:" />
        <echo message="${user.home}/bwbuild was left unchanged. You may need" />
        <echo message="to update it for this release." />
        <echo message="========================================================" />
      </then>
    </if>
  </target>

  <macrodef name="initDirectory">
    <sequential>
      <var name="org.bedework.directory.account" value="@{account}" />
      <var name="org.bedework.directory.firstname"  value="@{firstName}" />
      <var name="org.bedework.directory.lastname"  value="@{lastName}" />
      <var name="org.bedework.directory.password"  value="@{password}" />

      <echo message="======== Add user ${org.bedework.directory.account} =======" />

      <ant antfile="${bedework.build.file}" inheritrefs="true"
             target="addUser" />
    </sequential>
  </macrodef></project>