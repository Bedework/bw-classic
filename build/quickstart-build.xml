<?xml version="1.0"?>

<!-- This is the ant build file for the bedework Calendar quickstart.

     It is imported by the quickstart build.xml ensuring all changes to this file
     appear in the repository.

     Authors: Mike Douglass   douglm@rpi.edu
-->

<project name="quickstart-build-file" default="usage" basedir=".">
  <property environment="env"/>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties" />

  <target name="README" depends="init"
          description="Describe targets and their usage">
    <loadfile property="org.bedework.README" srcFile="${org.bedework.calendar.dir}/docs/README"/>
    <echo message="${org.bedework.README}" />
  </target>

  <target name="usage" depends="init"
          description="Describe targets and their usage">
    <echo message="As distributed the package should be ready to go."/>
    <echo message="Ensure ant is on your path, (a version is in the" />
    <echo message="package)"/>
    <echo message=""/>
    <echo message="First in one window do"/>
    <echo message="    ant hsqldb"/>
    <echo message="This will start the hsqldb server ready for the "/>
    <echo message="application."/>
    <echo message=""/>
    <echo message="In another window do"/>
    <echo message="    ant tomcatstart"/>
    <echo message=""/>
    <echo message="Once tomcat is running you should be able to go to a"/>
    <echo message="browser and connect to"/>
    <echo message="    http://localhost:8080/bedework"/>
    <echo message="and follow the instructions."/>
    <echo message=""/>
    <echo message="To build the calendar do"/>
    <echo message="    ant deploy    or "/>
    <echo message="    ant deploy.debug "/>
    <echo message="which does a build and deploy of all components"/>
    <echo message=""/>
    <echo message="To rebuild the calendar do"/>
    <echo message="    ant clean.deploy    or "/>
    <echo message="    ant clean.deploy.debug "/>
    <echo message="which does a clean, build and deploy of all components"/>
    <echo message=""/>
    <echo message="See documentation in the docs directory or on bedework.org"/>
    <echo message="for instructions on creating a locally configured calendar application"/>
    <echo message=""/>
  </target>

   <!-- The only properties set below should be those directly used to
        invoke the targets below, in this file.
        Do not set properties here for tasks invoked in other build
        files.  Instead, make sure the targets work in calendar/build.xml,
        then invoke ant on the task in calendar/build.xml.

        For an example, of invoking ant on another build file,
        see the deploy target, below.
     -->
  <target name="init" >
    <dirname property="quickstart.dir" file="${ant.file}"/>

    <property name="org.bedework.project.bedework"
              location="${basedir}/bedework" />

    <property name="org.bedework.config.base"
              location="${org.bedework.project.bedework}/config" />

    <property name="bedework.build.file"
              location="${basedir}/bedework/build.xml" />
    <property name="org.bedework.user.build.properties"
              location="${user.home}/bedework.build.properties" />
    <dirname property="org.bedework.configuration.location"
             file="${org.bedework.user.build.properties}" />

    <echo message="Load user properties from ${org.bedework.user.build.properties}" />

    <!-- Load user property definition overrides -->
    <property file="${org.bedework.user.build.properties}" />

    <!-- Unfortunately it sits on top of everything
    <splash imageurl="file://${org.bedework.project.bedework}/docs/icons/bedeworkLogo.gif"/>
    -->
  </target>

  <target name="run.init" depends="init" >
    <property name="org.bedework.user.build.properties"
              location="${user.home}/bedework.build.properties" />

    <echo message="Load user properties from ${org.bedework.user.build.properties}" />

    <!-- Load user property definition overrides -->
    <property file="${org.bedework.user.build.properties}" />

    <!-- ==================== config properties ========================= -->
    <property name="org.bedework.config.properties"
              location="${org.bedework.config.base}/configs/democal.properties" />
    <property name="org.bedework.config.options"
              location="${org.bedework.config.base}/configs/democal.options.xml" />

    <echo message="==========================================================" />
    <echo message="Use config properties ${org.bedework.config.properties}" />
    <loadproperties
          srcFile="${org.bedework.config.properties}" >
      <filterchain>
        <expandproperties/>
      </filterchain>
    </loadproperties>
  </target>

  <!-- =================================================================
       The "build" target builds the jar files
       ================================================================= -->

  <target name="build" depends="init"
          description="builds the jars">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="build" />
    <tstamp prefix="endbuild" />
    <echo message="=================> Build finished at ${endbuild.TODAY}" />
  </target>

  <target name="clean.build" depends="clean"
          description="cleans then builds the jars">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean.build" />
  </target>

  <!-- =================================================================
       The "deploy" target builds and deploys the applications
       ================================================================= -->

  <target name="deploy" depends="init"
          description="builds and deploys the applications">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="deploy" />
  </target>

  <target name="deploy.debug" depends="init"
          description="builds and deploys the applications">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="deploy.debug" />
    <tstamp>
      <format property="deploydebug.time" pattern="MM/dd/yyyy HH:mm:ss"/>
    </tstamp>

    <echo message="=================> deploy.debug finished at ${deploydebug.time}" />
  </target>

  <!-- =================================================================
       The "clean.deploy" target cleans, builds and deploys the applications
       ================================================================= -->

  <target name="clean" depends="init"
          description="Remove all generated files.">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean" />
  </target>

  <target name="quickstart-clean" depends="init"
          description="partial clean up for quickstart.">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="quickstart-clean" />
  </target>

  <target name="clean.deploy" depends="init"
          description="builds and deploys the applications">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean.deploy" />
  </target>

  <target name="clean.deploy.debug" depends="init"
          description="builds and deploys the applications">
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean.deploy.debug" />
  </target>

  <!-- =================================================================
       The "build.configured" target builds configured applications
       ================================================================= -->

  <target name="build.configured" depends="init"
          description="Build configured applications" >
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="build.configured" />
  </target>

  <target name="build.configured.debug" depends="init"
          description="Build configured applications" >
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="build.configured.debug" />
  </target>

  <target name="clean.build.configured" depends="init"
          description="Build configured applications" >
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean.build.configured" />
  </target>

  <target name="clean.build.configured.debug" depends="init"
          description="Build configured applications" >
    <ant antfile="${bedework.build.file}" inheritrefs="true"
           target="clean.build.configured.debug" />
  </target>

  <!-- =================================================================
       The "javadoc" target builds javadocs for all projects
       ================================================================= -->

  <target name="javadoc" depends="init"
          description="Build javadocs" >
    <ant antfile="${bedework.build.file}" inheritrefs="true"
         target="javadoc" />
  </target>

  <!-- =================================================================
       The "hsqldb" target starts the hsqldb server
       ================================================================= -->

  <target name="hsqldb" depends="run.init"
          description="starts the hsqldb server">
    <echo message="Starting hsqldb"/>
    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.dbname}"/>
      <arg value="-port"/>
      <arg value="8887"/>
    </java>
  </target>

  <target name="hsqldb-trace" depends="run.init"
          description="starts the hsqldb server">
    <echo message="Starting hsqldb"/>
    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-trace"/>
      <arg value="true"/>
      <arg value="-silent"/>
      <arg value="false"/>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.dbname}"/>
      <arg value="-port"/>
      <arg value="8887"/>
    </java>
  </target>

  <target name="hsqldb-trace-9887" depends="run.init"
          description="starts the hsqldb server">
    <echo message="Starting hsqldb"/>
    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-trace"/>
      <arg value="true"/>
      <arg value="-silent"/>
      <arg value="false"/>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.dbname}"/>
      <arg value="-port"/>
      <arg value="9887"/>
    </java>
  </target>

  <target name="uportaldb" depends="run.init"
          description="starts the hsqldb server">
    <echo message="Starting hsqldb"/>
    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.uportal2.dbname}"/>
      <arg value="-port"/>
      <arg value="9887"/>
    </java>
  </target>

  <!-- =================================================================
       The "hsqldb-test" target starts the hsqldb server for testing
       ================================================================= -->

  <target name="hsqldb-test" depends="run.init"
          description="starts the hsqldb server for testing">
    <echo message="Starting hsqldb for testing"/>
    <delete dir="${org.bedework.hsqldb.dbdir}" />

    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.test.dbdir}/events"/>
      <arg value="-port"/>
      <arg value="8887"/>
    </java>
  </target>

  <target name="hsqldb-test-trace" depends="run.init"
          description="starts the hsqldb server for testing">
    <echo message="Starting hsqldb for testing"/>
    <delete dir="${org.bedework.hsqldb.dbdir}" />

    <java fork="true" dir="${basedir}" classname="org.hsqldb.Server">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
      <arg value="-trace"/>
      <arg value="true"/>
      <arg value="-silent"/>
      <arg value="false"/>
      <arg value="-database"/>
      <arg value="${org.bedework.hsqldb.dir}/${org.bedework.hsqldb.test.dbdir}/events"/>
      <arg value="-port"/>
      <arg value="8887"/>
    </java>
  </target>

  <!-- =================================================================
       The "hsqldb-mngr" target runs the DatabaseManager class which
       provides a gui interface to the running hsqldb database.
       ================================================================= -->

  <target name="hsqldb-mngr" depends="run.init"
          description="Runs the DatabaseManager class which provides a
                       gui interface to the running hsqldb database">
    <echo message="Starting hsqldb DatabaseManager"/>
    <echo message="Select type: HSQL Database Engine Server"/>
    <echo message="Set the URL to jdbc:hsqldb:hsql://localhost:8887"/>
    <java fork="true" dir="${basedir}"
          classname="org.hsqldb.util.DatabaseManager">
      <classpath>
        <pathelement path="${org.bedework.hsqldb.dir}/lib/hsqldb.jar"/>
      </classpath>
    </java>
  </target>

  <!-- =================================================================
       The "tomcatstart" target starts Tomcat
       ================================================================= -->

  <target name="tomcatstart-locale" depends="run.init"
          description="starts the tomcat server">
    <input message="Enter language code: "
           addproperty="tomcat.locale" />

    <input message="Enter country code: "
           addproperty="tomcat.country" />

    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Duser.language=${tomcat.locale}"/>
      <jvmarg value="-Duser.country=${tomcat.country}"/>
      <!--
      <jvmarg value="-Dfile.encoding=ISO-8859-1"/>
      -->
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart" depends="run.init"
          description="starts the tomcat server">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx630m" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <jvmarg value="-Dfile.encoding=UTF-8"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-large" depends="run.init"
          description="starts a large memory version of the tomcat server">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xrunyjpagent:cpu=times,onexit=cpu" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile-large" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-server" />
      <jvmarg value="-agentlib:hprof=cpu=samples,depth=15,onexit=memory" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile-yk" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-server" />
      <jvmarg value="-agentlib:yjpagent" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-debug" depends="run.init"
          description="starts the tomcat server with remote debugging enabled">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <jvmarg value="-Xdebug"/>
      <jvmarg value="-Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n"/>
      <arg value="start"/>
    </java>
  </target>

  <!-- This target is for use when sync4j is installed -->
  <target name="tomcatstart-sync4j" depends="run.init"
          description="starts the tomcat server with sync4j">
    <echo message="Starting Tomcat with sync4j"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Dsync4j.home=${sync4j.dir}"/>
      <arg value="start"/>
    </java>
  </target>

  <!-- =================================================================
       The "tomcatstop" target stops Tomcat cleanly
       ================================================================= -->

  <target name="tomcatstop" depends="run.init">
    <echo message="Stopping Tomcat"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <arg value="stop"/>
    </java>
  </target>
</project>
